# Global configuration
{

    
    
}

# proxy directive snippet (with logging) to be used as follows:
#
#     import proxy "containername:port"
(proxy) {
    log {
        output stdout
        format filter {
            wrap json
            fields {
                common_log delete
                request>headers delete
                resp_headers delete
                tls delete
            }
        }
    }

    # This will compress requests that matches the default criteria set by Caddy.
    # see https://caddyserver.com/docs/caddyfile/directives/encode
    # for information about the defaults; i.e. how/when this will be applied.
    encode gzip

    reverse_proxy {args[0]} {
        header_up X-Forwarded-Port 80
    }

    
}

nuc.ali{$default_site_port}, preview.nuc.ali{$default_site_port} {
    @favicon_matcher {
        path_regexp ^/favicon.ico$
    }
    rewrite @favicon_matcher /theming/asset/images/favicon.ico

    # Limit profile image upload size
    handle_path /api/profile_images/*/*/upload {
        request_body {
            max_size 1MB
        }
    }

    import proxy "lms:8000"

    

    handle_path /* {
        request_body {
            max_size 4MB
        }
    }
}

studio.nuc.ali{$default_site_port} {
    @favicon_matcher {
        path_regexp ^/favicon.ico$
    }
    rewrite @favicon_matcher /theming/asset/images/favicon.ico

    import proxy "cms:8000"

    

    handle_path /* {
        request_body {
            max_size 250MB
        }
    }
}

apps.nuc.ali{$default_site_port} {
    redir / http://nuc.ali
    request_body {
        max_size 2MB
    }
    import proxy "mfe:8002"
}
# MinIO
files.nuc.ali{$default_site_port} {
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Credentials true
        Access-Control-Allow-Methods *
        Access-Control-Allow-Headers *
        defer
    }
    @video_id {
        query x-amz-meta-client_video_id=*
    }

    @course_key {
        query x-amz-meta-course_key=*
    }
    reverse_proxy minio:9000 {
        header_up -*
        header_up x-amz-meta-client_video_id {http.request.uri.query.x-amz-meta-client_video_id}
        header_up x-amz-meta-course_key {http.request.uri.query.x-amz-meta-course_key}
        header_up Content-Type {http.request.header.Content-Type}
        header_up Content-Length {http.request.header.Content-Length}
        header_down -Access-Control-Allow-Origin
    }
}
minio.nuc.ali{$default_site_port} {
    import proxy "minio:9001"
}
